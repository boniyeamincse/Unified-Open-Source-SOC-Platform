####################################################################
#  Unified Open-Source SOC Platform
#  Author : Boni Yeamin
#  Open Source V:1.0
#  File   : docker-compose.yml
#  Purpose: Main Docker orchestration â€” spins up all SOC services
#           inside an isolated network (soc_net).
####################################################################

# Step 1: Define the Compose file format version
version: "3.9"

networks:
  soc_net:
    driver: bridge

volumes:
  wazuh_data:
  opensearch_data:
  misp_db:
  thehive_data:
  cortex_data:
  openvas_data:
  postgres_data:


services:

  # ---------------------------
  # WAZUH SIEM
  # ---------------------------
  wazuh.manager:
    image: wazuh/wazuh-manager:4.7.2 # Pinned version (no :latest)
    container_name: wazuh.manager
    restart: always
    networks:
      - soc_net
    volumes:
      - wazuh_data:/var/ossec/data
    ports:
      - "1514:1514/udp" # Agent communication (UDP required)
      - "1515:1515" # Agent enrollment
      - "127.0.0.1:55000:55000" # SEC-07: API bound to localhost only
    mem_limit: 2g
    cpus: 2.0
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD", "/var/ossec/bin/wazuh-control", "status" ]
      interval: 30s
      timeout: 10s
      retries: 3

  wazuh.indexer:
    image: wazuh/wazuh-indexer:4.7.2 # Pinned version
    container_name: wazuh.indexer
    restart: always
    networks:
      - soc_net
    volumes:
      - opensearch_data:/var/lib/wazuh-indexer
    environment:
      - discovery.type=single-node
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
    mem_limit: 2g
    cpus: 2.0
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf http://localhost:9200/_cluster/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5

  wazuh.dashboard:
    image: wazuh/wazuh-dashboard:4.7.2 # Pinned version
    container_name: wazuh.dashboard
    restart: always
    networks:
      - soc_net
    ports:
      - "127.0.0.1:5601:5601" # SEC-07: Bound to localhost
    mem_limit: 1g
    cpus: 1.0
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf http://localhost:5601/api/status || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------
  # SURICATA IDS
  # ---------------------------
  suricata:
    image: jasonish/suricata:7.0.3 # Pinned version
    container_name: suricata
    restart: always
    network_mode: host # Required for packet capture
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_NICE
    cap_drop:
      - ALL
    volumes:
      - ./suricata:/etc/suricata
    mem_limit: 2g
    cpus: 2.0
    security_opt:
      - no-new-privileges:true

  # ---------------------------
  # MISP Threat Intel
  # ---------------------------
  misp:
    image: coolacid/misp-docker:2.4.178 # Pinned version
    container_name: misp
    restart: always
    networks:
      - soc_net
    ports:
      - "127.0.0.1:8080:80" # SEC-07: Bound to localhost
    environment:
      - MYSQL_PASSWORD=${MISP_DB_PASSWORD}
    volumes:
      - misp_db:/var/lib/mysql
    mem_limit: 2g
    cpus: 1.5
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf http://localhost/users/login || exit 1" ]
      interval: 60s
      timeout: 10s
      retries: 5

  # ---------------------------
  # POSTGRES (TheHive)
  # ---------------------------
  postgres:
    image: postgres:15-alpine # Pinned + Alpine (smaller surface)
    container_name: postgres
    restart: always
    networks:
      - soc_net
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: thehive
      POSTGRES_USER: thehive
    volumes:
      - postgres_data:/var/lib/postgresql/data
    mem_limit: 1g
    cpus: 1.0
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U thehive" ]
      interval: 15s
      timeout: 5s
      retries: 5

  # ---------------------------
  # THEHIVE
  # ---------------------------
  thehive:
    image: strangebee/thehive:5.2 # Pinned version
    container_name: thehive
    restart: always
    networks:
      - soc_net
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "127.0.0.1:9000:9000" # SEC-07: Bound to localhost
    volumes:
      - thehive_data:/opt/thp/thehive/data
    environment:
      - THEHIVE_SECRET=${THEHIVE_SECRET}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - CORTEX_API_KEY=${CORTEX_API_KEY}
    mem_limit: 2g
    cpus: 1.5
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf http://localhost:9000/api/status || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5

  # ---------------------------
  # CORTEX
  # ---------------------------
  cortex:
    image: thehiveproject/cortex:3.1.7 # Pinned version
    container_name: cortex
    restart: always
    networks:
      - soc_net
    ports:
      - "127.0.0.1:9001:9001" # SEC-07: Bound to localhost
    volumes:
      - cortex_data:/opt/cortex/data
    environment:
      - CORTEX_SECRET=${CORTEX_SECRET}
    mem_limit: 2g
    cpus: 1.5
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf http://localhost:9001/api/status || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5

  # ---------------------------
  # OPENVAS (Greenbone)
  # ---------------------------
  openvas:
    image: greenbone/community-edition:22.4 # Pinned version
    container_name: openvas
    restart: always
    networks:
      - soc_net
    ports:
      - "127.0.0.1:9392:9392" # SEC-07: Bound to localhost
    volumes:
      - openvas_data:/data
    mem_limit: 4g
    cpus: 2.0
    security_opt:
      - no-new-privileges:true

  # ---------------------------
  # SHUFFLE (SOAR Automation)
  # ---------------------------
  shuffle:
    image: frikky/shuffle:1.3.0 # Pinned version
    container_name: shuffle
    restart: always
    networks:
      - soc_net
    ports:
      - "127.0.0.1:3001:3001" # SEC-07: Bound to localhost
    mem_limit: 1g
    cpus: 1.0
    security_opt:
      - no-new-privileges:true

  # ---------------------------
  # NGINX (Reverse Proxy)
  # ---------------------------
  nginx:
    image: nginx:1.25-alpine # Pinned + Alpine
    container_name: nginx
    restart: always
    networks:
      - soc_net
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
    depends_on:
      - wazuh.dashboard
      - misp
      - thehive
      - cortex
    mem_limit: 512m
    cpus: 0.5
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run
      - /tmp
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf http://localhost:80/ || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 3
