####################################################################
#  Unified Open-Source SOC Platform
#  Author : Boni Yeamin
#  Open Source V:1.0
#  File   : docker-compose.yml
#  Purpose: Main Docker orchestration — spins up all SOC services
#           with 3-tier network segmentation and Keycloak SSO.
####################################################################

version: "3.9"

# ── 3-Tier Network Segmentation (Phase 2) ─────────────
networks:
  net-mgmt:
    driver: bridge
    # Management tier: Nginx, Keycloak — external-facing
  net-app:
    driver: bridge
    # Application tier: TheHive, Cortex, MISP, Shuffle, OpenVAS
  net-data:
    driver: bridge
    # Data tier: Wazuh, OpenSearch, PostgreSQL

volumes:
  wazuh_data:
  opensearch_data:
  misp_db:
  thehive_data:
  cortex_data:
  openvas_data:
  postgres_data:
  keycloak_db_data:
  audit_logs:
  redis_data:


services:

  # ===========================================================
  # MANAGEMENT TIER (net-mgmt)
  # ===========================================================

  # ---------------------------
  # NGINX (Reverse Proxy)
  # ---------------------------
  nginx:
    image: nginx:1.25-alpine
    container_name: nginx
    restart: always
    networks:
      - net-mgmt
      - net-app # Needs to reach app services for proxying
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
    depends_on:
      - wazuh.dashboard
      - misp
      - thehive
      - cortex
      - keycloak
    mem_limit: 512m
    cpus: 0.5
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run
      - /tmp
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf http://localhost:80/ || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 3

  # ---------------------------
  # KEYCLOAK SSO (Phase 2)
  # ---------------------------
  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: keycloak
    restart: always
    networks:
      - net-mgmt
      - net-app # Services need to reach Keycloak for OIDC
    command: start --import-realm
    ports:
      - "127.0.0.1:8443:8443"
    environment:
      KC_DB: postgres
      KC_DB_URL_HOST: keycloak_db
      KC_DB_URL_DATABASE: keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD}
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_HOSTNAME: auth.soc.local
      KC_HTTPS_CERTIFICATE_FILE: /opt/keycloak/certs/keycloak.crt
      KC_HTTPS_CERTIFICATE_KEY_FILE: /opt/keycloak/certs/keycloak.key
      KC_PROXY: edge
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
    volumes:
      - ./keycloak/realm-soc.json:/opt/keycloak/data/import/realm-soc.json:ro
      - ./nginx/certs:/opt/keycloak/certs:ro
    depends_on:
      keycloak_db:
        condition: service_healthy
    mem_limit: 1g
    cpus: 1.0
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD-SHELL", "exec 3<>/dev/tcp/localhost/8443 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '\"status\": \"UP\"'" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  keycloak_db:
    image: postgres:15-alpine
    container_name: keycloak_db
    restart: always
    networks:
      - net-mgmt
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD}
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    mem_limit: 512m
    cpus: 0.5
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U keycloak" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================
  # APPLICATION TIER (net-app)
  # ===========================================================

  # ---------------------------
  # MISP Threat Intel
  # ---------------------------
  misp:
    image: coolacid/misp-docker:2.4.178
    container_name: misp
    restart: always
    networks:
      - net-app
      - net-data # Needs Redis access
    ports:
      - "127.0.0.1:8080:80"
    environment:
      - MYSQL_PASSWORD=${MISP_DB_PASSWORD}
    volumes:
      - misp_db:/var/lib/mysql
    depends_on:
      redis:
        condition: service_healthy
    mem_limit: 2g
    cpus: 1.5
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf http://localhost/users/login || exit 1" ]
      interval: 60s
      timeout: 10s
      retries: 5

  # ---------------------------
  # THEHIVE
  # ---------------------------
  thehive:
    image: strangebee/thehive:5.2
    container_name: thehive
    restart: always
    networks:
      - net-app
      - net-data # Needs PostgreSQL access
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    ports:
      - "127.0.0.1:9000:9000"
    volumes:
      - thehive_data:/opt/thp/thehive/data
      - ./thehive/application.conf:/etc/thehive/application.conf:ro
      - audit_logs:/var/log/soc
    environment:
      - THEHIVE_SECRET=${THEHIVE_SECRET}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - CORTEX_API_KEY=${CORTEX_API_KEY}
    mem_limit: 2g
    cpus: 1.5
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf http://localhost:9000/api/status || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5

  # ---------------------------
  # CORTEX
  # ---------------------------
  cortex:
    image: thehiveproject/cortex:3.1.7
    container_name: cortex
    restart: always
    networks:
      - net-app
    ports:
      - "127.0.0.1:9001:9001"
    volumes:
      - cortex_data:/opt/cortex/data
    environment:
      - CORTEX_SECRET=${CORTEX_SECRET}
    mem_limit: 2g
    cpus: 1.5
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf http://localhost:9001/api/status || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5

  # ---------------------------
  # OPENVAS (Greenbone)
  # ---------------------------
  openvas:
    image: greenbone/community-edition:22.4
    container_name: openvas
    restart: always
    networks:
      - net-app
    ports:
      - "127.0.0.1:9392:9392"
    volumes:
      - openvas_data:/data
    mem_limit: 4g
    cpus: 2.0
    security_opt:
      - no-new-privileges:true

  # ---------------------------
  # SHUFFLE (SOAR Automation)
  # ---------------------------
  shuffle:
    image: frikky/shuffle:1.3.0
    container_name: shuffle
    restart: always
    networks:
      - net-app
    ports:
      - "127.0.0.1:3001:3001"
    mem_limit: 1g
    cpus: 1.0
    security_opt:
      - no-new-privileges:true

  # ===========================================================
  # DATA TIER (net-data)
  # ===========================================================

  # ---------------------------
  # WAZUH SIEM
  # ---------------------------
  wazuh.manager:
    image: wazuh/wazuh-manager:4.7.2
    container_name: wazuh.manager
    restart: always
    networks:
      - net-data
    volumes:
      - wazuh_data:/var/ossec/data
      - ./wazuh/ossec.conf:/var/ossec/etc/ossec.conf:ro
      - ./wazuh/rules/soc-correlation.xml:/var/ossec/etc/rules/soc-correlation.xml:ro
      - ./wazuh/wazuh-misp-integration.py:/var/ossec/integrations/custom-misp.py:ro
      - audit_logs:/var/log/soc
    ports:
      - "1514:1514/udp"
      - "1515:1515"
      - "127.0.0.1:55000:55000"
    mem_limit: 2g
    cpus: 2.0
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD", "/var/ossec/bin/wazuh-control", "status" ]
      interval: 30s
      timeout: 10s
      retries: 3

  wazuh.indexer:
    image: wazuh/wazuh-indexer:4.7.2
    container_name: wazuh.indexer
    restart: always
    networks:
      - net-data
    volumes:
      - opensearch_data:/var/lib/wazuh-indexer
    environment:
      - discovery.type=single-node
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
    mem_limit: 2g
    cpus: 2.0
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf http://localhost:9200/_cluster/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5

  wazuh.dashboard:
    image: wazuh/wazuh-dashboard:4.7.2
    container_name: wazuh.dashboard
    restart: always
    networks:
      - net-data
      - net-app # Nginx needs to reach dashboard via net-app
    ports:
      - "127.0.0.1:5601:5601"
    mem_limit: 1g
    cpus: 1.0
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf http://localhost:5601/api/status || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------
  # SURICATA IDS
  # ---------------------------
  suricata:
    image: jasonish/suricata:7.0.3
    container_name: suricata
    restart: always
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_NICE
    cap_drop:
      - ALL
    volumes:
      - ./suricata:/etc/suricata
    mem_limit: 2g
    cpus: 2.0
    security_opt:
      - no-new-privileges:true

  # ---------------------------
  # REDIS (MISP Cache + ZMQ)
  # ---------------------------
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: always
    networks:
      - net-data
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    mem_limit: 512m
    cpus: 0.5
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping" ]
      interval: 15s
      timeout: 5s
      retries: 3

  # ---------------------------
  # POSTGRES (TheHive)
  # ---------------------------
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    restart: always
    networks:
      - net-data
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: thehive
      POSTGRES_USER: thehive
    volumes:
      - postgres_data:/var/lib/postgresql/data
    mem_limit: 1g
    cpus: 1.0
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U thehive" ]
      interval: 15s
      timeout: 5s
      retries: 5
