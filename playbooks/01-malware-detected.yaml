####################################################################
#  SOAR Playbook: 01 — Malware Detected
####################################################################
name: "Malware Detected"
id: "PB-001"
version: "1.0"
author: "Boni Yeamin"
severity: P1
mitre:
  tactics: ["Execution", "Defense Evasion"]
  techniques: ["T1204", "T1036"]

trigger:
  source: "wazuh"
  conditions:
    - rule_group: "syscheck"
    - rule_level: ">=12"
    - tag: "malware"

steps:
  - id: 1
    action: "enrich_ioc"
    description: "Check file hash against MISP and VirusTotal"
    target: "misp"
    params:
      fields: ["md5", "sha256", "filename"]

  - id: 2
    action: "isolate_host"
    description: "Immediately isolate the affected host from network"
    auto_execute: true
    priority: "emergency"
    condition: "step_1.result.malicious == true"

  - id: 3
    action: "collect_evidence"
    description: "Capture running processes, network connections, memory"
    params:
      collect: ["processes", "network_connections", "file_timeline", "memory_dump"]

  - id: 4
    action: "quarantine_file"
    description: "Move malicious file to quarantine"
    auto_execute: true

  - id: 5
    action: "create_case"
    target: "thehive"
    params:
      title: "Malware Detection — ${agent.name} — ${file.hash}"
      severity: 3
      tags: ["malware", "syscheck", "auto-isolated"]

  - id: 6
    action: "notify_soc"
    params:
      channel: "soc-alerts"
      priority: "high"

escalation:
  auto_escalate_after_minutes: 15
  escalate_to: "soc-analyst"

containment:
  auto_contain: true
  actions: ["isolate_host", "quarantine_file"]

evidence:
  collect:
    - "Malicious file sample"
    - "Process tree at time of detection"
    - "Network connections from affected host"
    - "FIM change log for 24h before detection"
