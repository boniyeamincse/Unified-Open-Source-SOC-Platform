####################################################################
#  SOAR Playbook: 02 — Phishing Email Reported
####################################################################
name: "Phishing Email"
id: "PB-002"
version: "1.0"
author: "Boni Yeamin"
severity: P2
mitre:
  tactics: ["Initial Access"]
  techniques: ["T1566.001", "T1566.002"]

trigger:
  source: "email_report"
  conditions:
    - type: "user_report"
    - tag: "phishing"

steps:
  - id: 1
    action: "extract_iocs"
    description: "Extract URLs, attachments, sender domain"
    params:
      extract: ["urls", "attachments", "headers", "sender"]

  - id: 2
    action: "enrich_ioc"
    description: "Check extracted IOCs against MISP + VirusTotal"
    target: "misp"

  - id: 3
    action: "block_sender"
    description: "Block sender domain in email gateway"
    auto_execute: true
    condition: "step_2.result.malicious == true"

  - id: 4
    action: "search_mailboxes"
    description: "Search for same email across all mailboxes"
    params:
      search_by: ["sender", "subject", "attachment_hash"]

  - id: 5
    action: "quarantine_emails"
    description: "Remove matching emails from all mailboxes"
    condition: "step_4.result.count > 0"

  - id: 6
    action: "create_case"
    target: "thehive"
    params:
      title: "Phishing Campaign — ${sender_domain}"
      severity: 2
      tags: ["phishing", "email"]

  - id: 7
    action: "notify_users"
    description: "Warn users who received the email"
    params:
      template: "phishing_warning"

escalation:
  auto_escalate_after_minutes: 60
  escalate_to: "soc-analyst"

containment:
  auto_contain: true
  actions: ["block_sender", "quarantine_emails"]
---
####################################################################
#  SOAR Playbook: 03 — SSH Brute Force
####################################################################
name: "SSH Brute Force"
id: "PB-003"
version: "1.0"
author: "Boni Yeamin"
severity: P2
mitre:
  tactics: ["Credential Access"]
  techniques: ["T1110.001"]

trigger:
  source: "wazuh"
  conditions:
    - rule_id: 100001
    - rule_level: ">=10"

steps:
  - id: 1
    action: "geolocate_ip"
    description: "GeoIP lookup on source IP"
    params:
      field: "data.srcip"

  - id: 2
    action: "check_reputation"
    description: "Check IP against threat intel feeds"
    target: "misp"

  - id: 3
    action: "block_ip"
    description: "Block source IP at firewall level"
    target: "wazuh"
    params:
      action: "firewall-drop"
      duration: 3600
    auto_execute: true

  - id: 4
    action: "check_success"
    description: "Check if any login succeeded from this IP"
    params:
      query: "srcip:${data.srcip} AND rule.id:5715"
      timerange: "1h"

  - id: 5
    action: "create_case"
    target: "thehive"
    condition: "step_4.result.count > 0"
    params:
      title: "SSH Brute Force SUCCESS — ${data.srcip}"
      severity: 3
      tags: ["brute-force", "ssh", "compromised"]

escalation:
  auto_escalate_after_minutes: 30
  condition: "step_4.result.count > 0"

containment:
  auto_contain: true
  actions: ["block_ip"]
---
####################################################################
#  SOAR Playbook: 04 — RDP Brute Force
####################################################################
name: "RDP Brute Force"
id: "PB-004"
version: "1.0"
author: "Boni Yeamin"
severity: P2
mitre:
  tactics: ["Credential Access"]
  techniques: ["T1110.001"]

trigger:
  source: "wazuh"
  conditions:
    - rule_id: 100003

steps:
  - id: 1
    action: "geolocate_ip"
  - id: 2
    action: "check_reputation"
    target: "misp"
  - id: 3
    action: "block_ip"
    auto_execute: true
    params:
      duration: 3600
  - id: 4
    action: "disable_rdp"
    description: "Disable RDP if not business-critical"
    condition: "asset.rdp_required == false"
  - id: 5
    action: "create_case"
    target: "thehive"

containment:
  auto_contain: true
  actions: ["block_ip"]
---
####################################################################
#  SOAR Playbook: 05 — Ransomware Behavior
####################################################################
name: "Ransomware Behavior"
id: "PB-005"
version: "1.0"
author: "Boni Yeamin"
severity: P1
mitre:
  tactics: ["Impact"]
  techniques: ["T1486", "T1490"]

trigger:
  source: "wazuh"
  conditions:
    - rule_id_any: [100030, 100031, 100032]
    - rule_level: ">=14"

steps:
  - id: 1
    action: "isolate_host"
    description: "IMMEDIATE network isolation"
    auto_execute: true
    priority: "emergency"
  - id: 2
    action: "snapshot_state"
    description: "Capture running processes, network, and file system state"
  - id: 3
    action: "check_backups"
    description: "Verify backup integrity and last successful backup"
  - id: 4
    action: "create_case"
    target: "thehive"
    params:
      title: "RANSOMWARE ALERT — ${agent.name}"
      severity: 4
      tags: ["ransomware", "critical", "P1"]
  - id: 5
    action: "page_oncall"
    description: "Page on-call security engineer"
    params:
      method: ["phone", "sms", "slack"]
      require_ack: true

escalation:
  auto_escalate_after_minutes: 5
  escalate_to: "soc-admin"
  executive_notification: true

containment:
  auto_contain: true
  actions: ["isolate_host", "disable_shares", "snapshot_volumes"]
  rollback_after_hours: 0
  require_approval_for_rollback: true
---
####################################################################
#  SOAR Playbook: 06 — Data Exfiltration
####################################################################
name: "Data Exfiltration"
id: "PB-006"
version: "1.0"
author: "Boni Yeamin"
severity: P1
mitre:
  tactics: ["Exfiltration"]
  techniques: ["T1048"]

trigger:
  source: "wazuh"
  conditions:
    - rule_id: 100040

steps:
  - id: 1
    action: "analyze_destination"
    description: "Check destination IP reputation and country"
  - id: 2
    action: "block_destination"
    auto_execute: true
    condition: "step_1.result.reputation == 'malicious'"
  - id: 3
    action: "capture_traffic"
    description: "Start packet capture for forensics"
  - id: 4
    action: "identify_data"
    description: "Determine what data was transferred"
  - id: 5
    action: "create_case"
    target: "thehive"
    params:
      severity: 3
      tags: ["exfiltration", "data-loss"]

containment:
  auto_contain: true
  actions: ["block_destination"]
---
####################################################################
#  SOAR Playbook: 07 — Privilege Escalation
####################################################################
name: "Privilege Escalation"
id: "PB-007"
version: "1.0"
author: "Boni Yeamin"
severity: P2
mitre:
  tactics: ["Privilege Escalation"]
  techniques: ["T1548", "T1068"]

trigger:
  source: "wazuh"
  conditions:
    - rule_id_any: [100010, 100011, 100012]

steps:
  - id: 1
    action: "verify_authorized"
    description: "Check if privilege change was authorized via change management"
  - id: 2
    action: "review_user_activity"
    description: "Review user's recent 24h activity for suspicious patterns"
  - id: 3
    action: "create_case"
    target: "thehive"
    condition: "step_1.result.authorized == false"

containment:
  auto_contain: false
  actions: ["alert_soc"]
---
####################################################################
#  SOAR Playbook: 08 — Lateral Movement
####################################################################
name: "Lateral Movement"
id: "PB-008"
version: "1.0"
author: "Boni Yeamin"
severity: P1
mitre:
  tactics: ["Lateral Movement"]
  techniques: ["T1021"]

trigger:
  source: "wazuh"
  conditions:
    - rule_id_any: [100020, 100021]

steps:
  - id: 1
    action: "isolate_source"
    auto_execute: true
  - id: 2
    action: "map_accessed_hosts"
    description: "Identify all hosts accessed by the compromised account"
  - id: 3
    action: "disable_account"
    description: "Disable the compromised user account"
  - id: 4
    action: "scan_accessed_hosts"
    description: "Run integrity checks on all accessed hosts"
  - id: 5
    action: "create_case"
    target: "thehive"
    params:
      severity: 4
      tags: ["lateral-movement", "compromised"]

containment:
  auto_contain: true
  actions: ["isolate_source", "disable_account"]
---
####################################################################
#  SOAR Playbook: 09 — DNS Tunneling
####################################################################
name: "DNS Tunneling"
id: "PB-009"
version: "1.0"
author: "Boni Yeamin"
severity: P2
mitre:
  tactics: ["Command and Control", "Exfiltration"]
  techniques: ["T1071.004", "T1048.003"]

trigger:
  source: "suricata"
  conditions:
    - rule_id: 100041

steps:
  - id: 1
    action: "analyze_dns"
    description: "Decode DNS query patterns"
  - id: 2
    action: "block_domain"
    auto_execute: true
  - id: 3
    action: "identify_source"
    description: "Identify the process generating DNS queries"
  - id: 4
    action: "create_case"
    target: "thehive"

containment:
  auto_contain: true
  actions: ["block_domain"]
---
####################################################################
#  SOAR Playbook: 10 — SQL Injection
####################################################################
name: "SQL Injection Attack"
id: "PB-010"
version: "1.0"
author: "Boni Yeamin"
severity: P2
mitre:
  tactics: ["Initial Access"]
  techniques: ["T1190"]

trigger:
  source: "suricata"
  conditions:
    - signature: "SOC - SQL Injection Attempt"

steps:
  - id: 1
    action: "block_ip"
    auto_execute: true
  - id: 2
    action: "check_success"
    description: "Check if SQLi was successful (5xx errors, data leak)"
  - id: 3
    action: "add_waf_rule"
    description: "Add blocking rule to WAF/ModSecurity"
  - id: 4
    action: "create_case"
    target: "thehive"
    condition: "step_2.result.successful == true"

containment:
  auto_contain: true
  actions: ["block_ip", "add_waf_rule"]
---
####################################################################
#  SOAR Playbook: 11 — XSS Attack
####################################################################
name: "Cross-Site Scripting (XSS)"
id: "PB-011"
version: "1.0"
author: "Boni Yeamin"
severity: P3
mitre:
  tactics: ["Initial Access"]
  techniques: ["T1189"]

trigger:
  source: "suricata"
  conditions:
    - signature: "SOC - XSS Attempt Detected"

steps:
  - id: 1
    action: "log_attempt"
  - id: 2
    action: "check_csp"
    description: "Verify CSP headers are blocking execution"
  - id: 3
    action: "create_alert"
    target: "thehive"

containment:
  auto_contain: false
---
####################################################################
#  SOAR Playbook: 12 — Tor Usage
####################################################################
name: "Tor / Anonymizer Usage"
id: "PB-012"
version: "1.0"
author: "Boni Yeamin"
severity: P3
mitre:
  tactics: ["Command and Control"]
  techniques: ["T1090.003"]

trigger:
  source: "suricata"
  conditions:
    - rule_id: 100071

steps:
  - id: 1
    action: "identify_user"
  - id: 2
    action: "check_policy"
    description: "Is Tor usage authorized for this user/role?"
  - id: 3
    action: "create_alert"
    condition: "step_2.result.authorized == false"

containment:
  auto_contain: false
---
####################################################################
#  SOAR Playbook: 13 — Cryptocurrency Mining
####################################################################
name: "Cryptomining Detected"
id: "PB-013"
version: "1.0"
author: "Boni Yeamin"
severity: P2
mitre:
  tactics: ["Impact"]
  techniques: ["T1496"]

trigger:
  source: "suricata"
  conditions:
    - signature: "SOC - Cryptocurrency Mining Pool Access"

steps:
  - id: 1
    action: "identify_process"
  - id: 2
    action: "kill_process"
    auto_execute: true
  - id: 3
    action: "block_pool"
    auto_execute: true
  - id: 4
    action: "scan_host"
    description: "Full malware scan — miner might be part of larger compromise"
  - id: 5
    action: "create_case"
    target: "thehive"

containment:
  auto_contain: true
  actions: ["kill_process", "block_pool"]
---
####################################################################
#  SOAR Playbook: 14 — C2 Beacon
####################################################################
name: "Command & Control Beacon"
id: "PB-014"
version: "1.0"
author: "Boni Yeamin"
severity: P1
mitre:
  tactics: ["Command and Control"]
  techniques: ["T1071.001", "T1573"]

trigger:
  source: "wazuh"
  conditions:
    - rule_id: 100070

steps:
  - id: 1
    action: "isolate_host"
    auto_execute: true
  - id: 2
    action: "capture_traffic"
  - id: 3
    action: "reverse_engineer"
    description: "Analyze beacon pattern (interval, jitter, protocol)"
  - id: 4
    action: "ioc_extraction"
    description: "Extract C2 server IPs/domains"
  - id: 5
    action: "block_c2"
    auto_execute: true
  - id: 6
    action: "create_case"
    target: "thehive"
    params:
      severity: 4

containment:
  auto_contain: true
  actions: ["isolate_host", "block_c2"]
---
####################################################################
#  SOAR Playbook: 15 — Insider Threat / Anomalous Behavior
####################################################################
name: "Insider Threat"
id: "PB-015"
version: "1.0"
author: "Boni Yeamin"
severity: P2
mitre:
  tactics: ["Collection", "Exfiltration"]
  techniques: ["T1074", "T1048"]

trigger:
  source: "anomaly_detector"
  conditions:
    - anomaly_severity: ["High", "Critical"]

steps:
  - id: 1
    action: "review_activity"
    description: "Review user's 7-day activity timeline"
  - id: 2
    action: "check_data_access"
    description: "Identify sensitive data accessed"
  - id: 3
    action: "create_case"
    target: "thehive"
    params:
      tags: ["insider-threat", "ueba"]
  - id: 4
    action: "enable_monitoring"
    description: "Enable enhanced monitoring for this user"

containment:
  auto_contain: false
  actions: ["enhanced_monitoring"]
---
####################################################################
#  SOAR Playbook: 16 — Account Compromise
####################################################################
name: "Account Compromise"
id: "PB-016"
version: "1.0"
author: "Boni Yeamin"
severity: P1
mitre:
  tactics: ["Credential Access"]
  techniques: ["T1078"]

trigger:
  source: "wazuh"
  conditions:
    - rule_id: 100002

steps:
  - id: 1
    action: "disable_account"
    auto_execute: true
  - id: 2
    action: "revoke_sessions"
    description: "Terminate all active sessions in Keycloak"
  - id: 3
    action: "audit_access"
    description: "Review what the account accessed post-compromise"
  - id: 4
    action: "reset_credentials"
  - id: 5
    action: "create_case"
    target: "thehive"

containment:
  auto_contain: true
  actions: ["disable_account", "revoke_sessions"]
---
####################################################################
#  SOAR Playbook: 17 — Vulnerability Exploitation
####################################################################
name: "Known CVE Exploitation"
id: "PB-017"
version: "1.0"
author: "Boni Yeamin"
severity: P1
mitre:
  tactics: ["Initial Access"]
  techniques: ["T1190"]

trigger:
  source: "suricata"
  conditions:
    - rule_group: "exploit"

steps:
  - id: 1
    action: "identify_cve"
  - id: 2
    action: "check_patch_status"
  - id: 3
    action: "isolate_if_unpatched"
    auto_execute: true
    condition: "step_2.result.patched == false"
  - id: 4
    action: "emergency_patch"
  - id: 5
    action: "create_case"
    target: "thehive"

containment:
  auto_contain: true
  actions: ["isolate_host", "emergency_patch"]
---
####################################################################
#  SOAR Playbook: 18 — Policy Violation
####################################################################
name: "Policy Violation"
id: "PB-018"
version: "1.0"
author: "Boni Yeamin"
severity: P3
mitre:
  tactics: ["Policy Violation"]
  techniques: []

trigger:
  source: "wazuh"
  conditions:
    - rule_group: "policy_violation"

steps:
  - id: 1
    action: "identify_user"
  - id: 2
    action: "document_violation"
  - id: 3
    action: "notify_manager"
  - id: 4
    action: "create_alert"
    target: "thehive"

containment:
  auto_contain: false
---
####################################################################
#  SOAR Playbook: 19 — DoS/DDoS Attack
####################################################################
name: "Denial of Service"
id: "PB-019"
version: "1.0"
author: "Boni Yeamin"
severity: P1
mitre:
  tactics: ["Impact"]
  techniques: ["T1498", "T1499"]

trigger:
  source: "suricata"
  conditions:
    - type: "traffic_anomaly"
    - threshold: "10x_baseline"

steps:
  - id: 1
    action: "activate_rate_limiting"
    auto_execute: true
  - id: 2
    action: "geoblock"
    description: "Block traffic from non-business countries"
    auto_execute: true
  - id: 3
    action: "enable_cdn"
    description: "Activate CDN/scrubbing service"
  - id: 4
    action: "page_oncall"
  - id: 5
    action: "create_case"
    target: "thehive"
    params:
      severity: 3

containment:
  auto_contain: true
  actions: ["rate_limit", "geoblock"]
---
####################################################################
#  SOAR Playbook: 20 — Log Tampering / Evidence Destruction
####################################################################
name: "Log Tampering"
id: "PB-020"
version: "1.0"
author: "Boni Yeamin"
severity: P1
mitre:
  tactics: ["Defense Evasion"]
  techniques: ["T1070.001", "T1070.002"]

trigger:
  source: "wazuh"
  conditions:
    - rule_id_any: [100060, 100061]
    - rule_level: ">=14"

steps:
  - id: 1
    action: "snapshot_logs"
    description: "Immediately snapshot remaining log data"
    auto_execute: true
  - id: 2
    action: "isolate_host"
    auto_execute: true
  - id: 3
    action: "identify_actor"
    description: "Determine who/what cleared the logs"
  - id: 4
    action: "check_backup_logs"
    description: "Retrieve log copies from centralized SIEM"
  - id: 5
    action: "create_case"
    target: "thehive"
    params:
      severity: 4
      tags: ["log-tampering", "evidence-destruction", "P1"]

escalation:
  auto_escalate_after_minutes: 5
  escalate_to: "soc-admin"

containment:
  auto_contain: true
  actions: ["snapshot_logs", "isolate_host"]
