####################################################################
#  Unified Open-Source SOC Platform â€” CI Pipeline
#  Author : Boni Yeamin
#  Runs: lint, syntax check, security scan, deploy
####################################################################
name: SOC Platform CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  COMPOSE_PROJECT_NAME: soc

jobs:

  # â”€â”€ Lint & Validate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: Lint & Validate Configs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install linters
        run: pip install yamllint pyflakes

      - name: Lint YAML files
        run: |
          yamllint -d relaxed \
            docker-compose.yml \
            config/tenants.yaml \
            observability/prometheus.yaml \
            observability/docker-compose.observability.yml

      - name: Python syntax check
        run: |
          for f in scripts/*.py; do
            echo "Checking $f..."
            python3 -m py_compile "$f"
          done

      - name: Validate Docker Compose
        run: docker compose config --quiet

      - name: Validate Observability Compose
        run: |
          docker network create net-mgmt 2>/dev/null || true
          docker network create net-app 2>/dev/null || true
          docker compose -f observability/docker-compose.observability.yml config --quiet

      - name: Shell script lint
        run: |
          sudo apt-get install -y shellcheck
          shellcheck scripts/*.sh || true

  # â”€â”€ Security Scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          severity: "HIGH,CRITICAL"
          format: "table"

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

      - name: Check .env not committed with real secrets
        run: |
          if grep -qE '(password|secret|key).*=.{20,}' .env 2>/dev/null; then
            echo "âš ï¸ .env may contain real secrets. Verify before deploy."
          fi

  # â”€â”€ Container Image Scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  container-scan:
    name: Container Image Scan
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        image:
          - "wazuh/wazuh-manager:4.7.2"
          - "wazuh/wazuh-indexer:4.7.2"
          - "wazuh/wazuh-dashboard:4.7.2"
          - "strangebee/thehive:5.2"
          - "thehiveproject/cortex:3.1.7"
          - "quay.io/keycloak/keycloak:24.0"
    steps:
      - name: "Scan ${{ matrix.image }}"
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${{ matrix.image }}"
          severity: "HIGH,CRITICAL"
          format: "table"
          exit-code: "0"  # Don't fail â€” these are upstream images

  # â”€â”€ Deploy to Staging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [security, container-scan]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - name: Deploy via Docker Compose
        run: |
          echo "ğŸš€ Deploying to staging..."
          # docker compose pull
          # docker compose up -d
          echo "âœ… Staging deploy would happen here"

  # â”€â”€ Deploy to Production â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [security, container-scan]
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Pre-deploy backup
        run: |
          echo "ğŸ“¦ Running pre-deploy backup..."
          # bash scripts/backup-dr.sh backup

      - name: Blue-Green Deploy
        run: |
          echo "ğŸ”µğŸŸ¢ Blue-green deployment..."
          # docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
          echo "âœ… Production deploy would happen here"

      - name: Post-deploy health check
        run: |
          echo "ğŸ¥ Running health checks..."
          # curl -sf https://wazuh.soc.local/api/status
          # curl -sf https://thehive.soc.local/api/status
          # curl -sf https://auth.soc.local/health/ready
          echo "âœ… Health checks would run here"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Deploy failed. Rolling back..."
          # docker compose down
          # bash scripts/backup-dr.sh restore latest
