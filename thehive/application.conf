####################################################################
#  Unified Open-Source SOC Platform
#  Author : Boni Yeamin
#  Open Source V:1.0
#  File   : thehive/application.conf
#  Purpose: TheHive 5 Case Management configuration. Connects to
#           Cassandra (database), Elasticsearch (search index),
#           Cortex (automated analysis), and MISP (threat intel).
####################################################################
#
# Step 1: TheHive starts and connects to Cassandra for data storage
# Step 2: Elasticsearch provides full-text search for cases
# Step 3: Cortex integration enables automated IOC enrichment
# Step 4: MISP integration provides threat intelligence lookups
#

# ── TheHive 5 Application Configuration ───────────────────
# SOC Platform Integration

# =============================================================
# Database (PostgreSQL)
# =============================================================
db {
  provider = "postgres"
  postgres {
    host    = "postgres"
    port    = "5432"
    database = "thehive"
    user    = "thehive"
    password = ${?POSTGRES_PASSWORD}
  }
}

# =============================================================
# Index (Elasticsearch / OpenSearch)
# =============================================================
index {
  search {
    provider = "no-op"
  }
}

# =============================================================
# Storage
# =============================================================
storage {
  provider = local
  localFs {
    location = /opt/thp/thehive/data
  }
}

# =============================================================
# Authentication
# =============================================================
auth {
  providers = [
    {name = session, duration = "12 hours"},
    {name = basic, realm = thehive}
    # REMOVED: header-based auth (SEC-06) — X-Remote-User can be spoofed
    # To re-enable for trusted proxies ONLY, restrict via Nginx IP allowlist
  ]
}

# =============================================================
# Secret Key
# =============================================================
play.http.secret.key = ${?THEHIVE_SECRET}

# =============================================================
# Cortex Integration
# =============================================================
cortex {
  servers = [
    {
      name          = "cortex-1"
      url           = "http://cortex:9001"
      auth {
        type = "bearer"
        key  = ${?CORTEX_API_KEY}
      }
      ws {
        ssl {
          # SEC-04 FIX: Validate Cortex TLS certificates
          # If using self-signed certs, add CA to JVM truststore instead:
          #   keytool -import -trustcacerts -file ca.crt -alias cortex-ca -keystore $JAVA_HOME/lib/security/cacerts
        }
      }
    }
  ]
  refreshDelay  = 5 seconds
  maxRetryOnError = 3
  statusCheckInterval = 1 minute
}

# =============================================================
# MISP Integration
# =============================================================
misp {
  servers = [
    {
      name  = "misp-soc"
      url   = "http://misp:80"
      auth {
        type = "key"
        key  = ${?MISP_AUTH_KEY}
      }
    }
  ]
  interval        = 1 hour
  maxAge          = 2 days
  importedCaseTags = [ "misp:event" ]
  exportCaseTags   = [ "misp:export" ]
}

# =============================================================
# Notifications (Shuffle)
# =============================================================
notification.triggers = [
  { name = "CaseCreated" }
  { name = "AlertImported" }
]
