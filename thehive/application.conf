####################################################################
#  Unified Open-Source SOC Platform
#  Author : Boni Yeamin
#  Open Source V:1.0
#  File   : thehive/application.conf
#  Purpose: TheHive 5 Case Management configuration. Connects to
#           PostgreSQL (database), Cortex (automated analysis),
#           MISP (threat intel), and Keycloak (SSO via OIDC).
####################################################################
#
# Step 1: TheHive connects to PostgreSQL for case data storage
# Step 2: Keycloak provides SSO + MFA authentication (OIDC)
# Step 3: Cortex integration enables automated IOC enrichment
# Step 4: MISP integration provides threat intelligence lookups
#

# ── TheHive 5 Application Configuration ───────────────────
# SOC Platform Integration — Phase 2: Enterprise Access Control

# =============================================================
# Database (PostgreSQL)
# =============================================================
db {
  provider = "postgres"
  postgres {
    host    = "postgres"
    port    = "5432"
    database = "thehive"
    user    = "thehive"
    password = ${?POSTGRES_PASSWORD}
  }
}

# =============================================================
# Index (Elasticsearch / OpenSearch)
# =============================================================
index {
  search {
    provider = "no-op"
  }
}

# =============================================================
# Storage
# =============================================================
storage {
  provider = local
  localFs {
    location = /opt/thp/thehive/data
  }
}

# =============================================================
# Authentication (Phase 2 — Keycloak SSO + OIDC)
# =============================================================
auth {
  providers = [
    # Session-based auth with 15-minute idle timeout (SEC-09 / 2.5)
    {name = session, duration = "15 minutes"},

    # Local fallback (emergency access if Keycloak is down)
    {name = basic, realm = thehive},

    # Keycloak OIDC SSO (Primary authentication method)
    {
      name      = oauth2
      clientId  = "thehive"
      clientSecret = ${?KEYCLOAK_THEHIVE_SECRET}
      redirectUri = "https://thehive.soc.local/api/sso/oauth2/callback"
      responseType = "code"
      grantType = "authorization_code"
      authorizationUrl = "https://auth.soc.local/realms/soc-platform/protocol/openid-connect/auth"
      tokenUrl         = "https://auth.soc.local/realms/soc-platform/protocol/openid-connect/token"
      userUrl          = "https://auth.soc.local/realms/soc-platform/protocol/openid-connect/userinfo"
      scope = ["openid", "email", "profile"]
      userIdField = "email"
      userOrganisation = "soc"
      defaultRoles = ["read"]
      # Map Keycloak realm roles to TheHive profiles:
      #   soc-admin     → admin
      #   soc-lead      → org-admin
      #   soc-analyst   → analyst
      #   threat-hunter → analyst (with extended permissions)
      #   soc-readonly  → read
      autocreate = true
    }
  ]

  # Session security
  sessionMaxAge = "8 hours"    # Absolute session lifetime
  sessionInactivityTimeout = "15 minutes"  # Idle timeout
}

# =============================================================
# Secret Key
# =============================================================
play.http.secret.key = ${?THEHIVE_SECRET}

# =============================================================
# Cortex Integration
# =============================================================
cortex {
  servers = [
    {
      name          = "cortex-1"
      url           = "http://cortex:9001"
      auth {
        type = "bearer"
        key  = ${?CORTEX_API_KEY}
      }
      ws {
        ssl {
          # SEC-04 FIX: Validate Cortex TLS certificates
          # If using self-signed certs, add CA to JVM truststore instead:
          #   keytool -import -trustcacerts -file ca.crt -alias cortex-ca -keystore $JAVA_HOME/lib/security/cacerts
        }
      }
    }
  ]
  refreshDelay  = 5 seconds
  maxRetryOnError = 3
  statusCheckInterval = 1 minute
}

# =============================================================
# MISP Integration
# =============================================================
misp {
  servers = [
    {
      name  = "misp-soc"
      url   = "http://misp:80"
      auth {
        type = "key"
        key  = ${?MISP_AUTH_KEY}
      }
    }
  ]
  interval        = 1 hour
  maxAge          = 2 days
  importedCaseTags = [ "misp:event" ]
  exportCaseTags   = [ "misp:export" ]
}

# =============================================================
# Notifications (Shuffle)
# =============================================================
notification.triggers = [
  { name = "CaseCreated" }
  { name = "AlertImported" }
]
